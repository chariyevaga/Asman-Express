-- time functions
USE [LOGODB]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE OR ALTER FUNCTION [dbo].[AGO_CONVERT_TO_DATETIME](@DATE_WITHOUT_TIME DATETIME, @TIME_INT INT)
       RETURNS DATETIME
AS
BEGIN
 
 RETURN(ISNULL(TRY_CONVERT(DATETIME,CONCAT(LEFT(CONVERT(DATE,@DATE_WITHOUT_TIME,108),11), ' ',
            CONVERT(VARCHAR, CONVERT(DATETIME, 
                                            CAST(((@TIME_INT-(@TIME_INT%65536))/65536/256) AS VARCHAR(2)) +':'+
                                             CAST(((@TIME_INT-(@TIME_INT%65536))/65536-((@TIME_INT-(@TIME_INT%65536))/65536/256)*256) AS VARCHAR(2))+':'+
                                             CAST((((@TIME_INT%65536)-((@TIME_INT%65536)%256))/256) AS VARCHAR(2)) , 101),108))),@DATE_WITHOUT_TIME))
END
GO

CREATE OR ALTER FUNCTION [dbo].[AGO_INTTODATE](@LDATE INT)
       RETURNS DATETIME
AS
BEGIN
 DECLARE @DATE    DATETIME,
         @DD      INT,
         @MM      INT,
         @YYYY    INT,
         @DATESTR VARCHAR(12)
 SELECT @DD   = ((@LDATE%65536)/256)
 SELECT @MM   = (@LDATE%65536)%256
 SELECT @YYYY = (@LDATE/65536)
 SELECT @DATESTR = CAST(@DD AS VARCHAR(2))+'-'+
                   CAST(@MM AS VARCHAR(2))+'-'+
                   CAST(@YYYY AS VARCHAR(4))
 SELECT @DATE = CONVERT(DATETIME,@DATESTR,102)
 RETURN(@DATE)
END
GO

CREATE OR ALTER FUNCTION [dbo].[AGO_INTTOTIME](@LDATE INT)
       RETURNS VARCHAR(12)
AS
BEGIN
 DECLARE @TIME    DATETIME,
         @HH      INT,
         @MM      INT,
         @SS     INT,
         @TIMESTR VARCHAR(12),
         @RETSTR VARCHAR(12)
 SELECT @HH   = (@LDATE-(@LDATE%65536))/65536/256
 SELECT @MM   = ((@LDATE-(@LDATE%65536))/65536-((@LDATE-(@LDATE%65536))/65536/256)*256)
 SELECT @SS = (((@LDATE%65536)-((@LDATE%65536)%256))/256)
 SELECT @TIMESTR = CAST(@HH AS VARCHAR(2))+':'+
                   CAST(@MM AS VARCHAR(2))+':'+
                   CAST(@SS AS VARCHAR(2))
 SELECT @TIME = CONVERT(DATETIME,@TIMESTR,101)
 SELECT @RETSTR = CONVERT(VARCHAR,@TIME,108)
 RETURN(@RETSTR)
END
GO

/****** Object:  UserDefinedFunction [dbo].[AGO_TIMETOINT]    Script Date: 2/21/2022 10:02:14 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE OR ALTER FUNCTION [dbo].[AGO_TIMETOINT](@HH INT,@MM INT,@SS INT)
       RETURNS INT
AS
BEGIN
 DECLARE @TIME    INT
 SELECT @TIME   = (@HH*65536*256+@MM*65536+@SS*256)
 RETURN(@TIME)
END
GO


USE [GIYIMDB]
GO
-- brands
CREATE OR ALTER VIEW AGO_MM_BRANDS AS
SELECT 
	LOGICALREF id, 
	CODE code, 
	DESCR name,
	CAPIBLOCK_CREADEDDATE createdAt,
	CAPIBLOCK_MODIFIEDDATE updatedAt
FROM GIYIMDB..LG_002_MARK
GO

-- clients
CREATE OR ALTER VIEW AGO_MM_CLIENTS AS
SELECT 
	CLCARD.LOGICALREF id, 
	CASE WHEN CLCARD.ACTIVE = 0 THEN 1 ELSE 0 END active, 
	CARDTYPE cardType, 
	CODE code, 
	DEFINITION_ name, 
	DEFINITION2 name2, 
	LOGOID eCode, 
    ADDR1 address, 
	ADDR2 address2, 
	DISTRICT district, 
	TOWN town, 
	CITY city, 
	CITYCODE cityCode, 
	COUNTRY contry, 
	COUNTRYCODE contryCode,
    TELNRS1 phoneNumber, 
	TELNRS2 phoneNumber2, 
    EMAILADDR email, 
	EMAILADDR2 email2, 
	EMAILADDR3 email3,          
    INCHARGE incharge, 
	INCHARGE2 incharge2, 
	INCHARGE3 incharge3, 
	WEBADDR webAddress,
    CASE WHEN ISDATE(INCHARGE3) = 1 THEN INCHARGE3 ELSE null END birthDate, 
    ISNULL(NULLIF(CCURRENCY,0),158) currencyId,CURRATETYPE exchangeRateType, 
    DISCRATE discount, 
	SPECODE specode, 
	SPECODE2 specode2, 
	SPECODE3 specode3, 
	SPECODE4 specode4, 
	SPECODE5 specode5, 
	CYPHCODE cyphcode, 
	STORECREDITCARDNO cardNo,
    GUID guid
FROM GIYIMDB..LG_002_CLCARD CLCARD
WHERE CARDTYPE IN(1,3) AND SPECODE NOT IN('ANA GRUP', 'ALT GRUP')
GO

-- currencies
CREATE OR ALTER VIEW AGO_MM_CURRENCIES AS
SELECT 
	CURTYPE id, 
	CURCODE code, 
	CURNAME name, 
	CURSYMBOL symbol, 
	CURINUSE activelyUsed   
FROM LOGODB..L_CURRENCYLIST WHERE FIRMNR = 2
GO

-- exchanges
CREATE OR ALTER VIEW AGO_MM_EXCHANGES AS
SELECT
	LREF id, 
	LOGODB.dbo.AGO_INTTODATE(DATE_) date, 
	crtype currencyId, 
	ROUND(rates1, 10) rates1, 
	ROUND(rates2, 10) rates2, 
	ROUND(rates3, 10) rates3, 
	ROUND(rates4, 10) rates4   
FROM GIYIMDB..LG_EXCHANGE_002
GO

-- divisions
CREATE OR ALTER VIEW AGO_MM_DIVISIONS AS
SELECT
	LOGICALREF id,
	NR nr,
	NAME name,
	STREET street,
	DOORNR doorNr,
	DISTRICT district,
	CITY city,
	COUNTRY country,
	ZIPCODE zipCode,
	PHONE phone
FROM
LOGODB..L_CAPIDIV WHERE FIRMNR = 2
GO

-- items
CREATE OR ALTER VIEW AGO_MM_ITEMS AS
SELECT
	ITM.LOGICALREF id, 
	ITM.CODE code, 
	ITM.B2CCODE eCode, 
	CASE WHEN ITM.ACTIVE = 0 THEN 1 ELSE 0 END active, 
    CASE WHEN ITM.EXTACCESSFLAGS IN(4,5,6,7) THEN 1 ELSE 0 END eActive,
	ITM.CARDTYPE cardType,
    ITM.NAME name, 
	ITM.NAME2 name2, 
	ITM.NAME3 name3,
	ITM.STGRPCODE stgrpCode, 
	ITM.SPECODE specode, 
	ITM.SPECODE2 specode2, 
	ITM.SPECODE3 specode3, 
	ITM.SPECODE4 specode4, 
	ITM.SPECODE5 specode5,
    UL.NAME mainUnit,
    UL.LOGICALREF mainUnitId,
	ITM.MARKREF brandId,
    ISNULL(MK.SUBSGOODCODE,'') subsGoodCode,
    NULLIF(MK.REYONCODE,'') reyonCode,
    ISNULL(ITM.SALESLIMITQUANTITY,0) salesLimitQuantity
FROM GIYIMDB..LG_002_ITEMS ITM
LEFT JOIN GIYIMDB..LG_002_UNITSETL UL ON UL.UNITSETREF = ITM.UNITSETREF AND UL.MAINUNIT = 1
LEFT JOIN GIYIMDB..LG_002_ITEMS MG ON MG.SPECODE = 'ANA GRUP' AND MG.CARDTYPE IN(1,20,21) AND MG.CODE = LEFT(ITM.CODE, LEN(MG.CODE))
LEFT JOIN GIYIMDB..LG_002_ITEMS LG ON LG.SPECODE = 'ALT GRUP' AND LG.CARDTYPE IN(1,20,21) AND LG.CODE = LEFT(ITM.CODE, LEN(LG.CODE))
LEFT JOIN GIYIMDB..LG_002_MARKET MK ON MK.ITEMREF = ITM.LOGICALREF
WHERE ITM.SPECODE NOT IN ('ANA GRUP', 'ALT GRUP') AND ITM.CARDTYPE = 1 
GO

-- itemUnits
CREATE OR ALTER VIEW AGO_MM_ITEM_UNITS AS
SELECT
        I.LOGICALREF id,
        L.LOGICALREF unitId,
        ITM.LOGICALREF itemId,
        L.MAINUNIT mainUnit,
        I.LINENR lineNr,
        I.CONVFACT2 / CASE WHEN ISNULL(I.CONVFACT1,0) = 0 THEN 1 ELSE I.CONVFACT1 END  coefficient,
        CASE WHEN I.EXTACCESSFLAGS IN(1,3) THEN 1 ELSE 0 END eActive,
        I.WIDTH width,
        NULLIF(I.WIDTHREF,0) widthId,
        I.LENGTH length,
        NULLIF(I.LENGTHREF,0) lengthId,
        I.HEIGHT height,
        NULLIF(I.HEIGHTREF,0) heightId,
        I.AREA area,
        NULLIF(I.AREAREF,0) areaId,
        I.VOLUME_ volume,
        NULLIF(I.VOLUMEREF,0) volumeId,
        I.WEIGHT weight,
        NULLIF(I.WEIGHTREF,0) weightId,
        I.GROSSVOLUME grossvolume,
        NULLIF(I.GROSSVOLREF,0) grossvolumeId,
        I.GROSSWEIGHT grossweight,
        NULLIF(I.GROSSWGHTREF,0) grossweightId
FROM GIYIMDB..LG_002_ITMUNITA I
JOIN GIYIMDB..LG_002_UNITSETL L ON L.LOGICALREF = I.UNITLINEREF
JOIN GIYIMDB..LG_002_ITEMS ITM ON ITM.LOGICALREF = I.ITEMREF AND ITM.SPECODE NOT IN('ANA GRUP', 'ALT GRUP') AND ITM.CARDTYPE = 1
GO

-- units
CREATE OR ALTER VIEW AGO_MM_UNITS AS
SELECT
   LOGICALREF id,
   CODE code,
   NAME name
FROM  GIYIMDB..LG_002_UNITSETL
GO

--warehouses
CREATE OR ALTER VIEW AGO_MM_WAREHOUSES AS 
SELECT 
	LOGICALREF id,
	NR nr, 
	NAME name, 
	DIVISNR divisionNr, 
	FACTNR factoryNr, 
	COSTGRP costGrp
FROM LOGODB..L_CAPIWHOUSE
WHERE FIRMNR = 2 AND NR <> 0
GO

-- stocks
CREATE OR ALTER VIEW AGO_MM_STOCKS AS 
SELECT 
	STOCKREF itemId, 
	INVENNO warehouseNr, 
	ROUND(ONHAND,4) onhand, 
	ROUND(RESERVED,4) reserved
FROM GIYIMDB.dbo.LV_002_01_GNTOTST
INNER JOIN GIYIMDB.dbo.LG_002_ITEMS ITM ON ITM.LOGICALREF = STOCKREF
WHERE ITM.SPECODE NOT IN ('ANA GRUP', 'ALT GRUP') AND ITM.CARDTYPE = 1 AND INVENNO NOT IN(-1,0)