-- DON'T FORGET DATABASE NAME AND FIRM NUMBER 
USE [GIYIMDB]
GO
	-- alternativKeys model
	CREATE
	OR ALTER VIEW AGO_ATTRIBUTE_KEYS AS
SELECT
	LOGICALREF id,
	CODE code,
	NAME name,
	SPECODE specode
FROM
	GIYIMDB..LG_002_CHARCODE
GO
	-- alternativeValues model
	CREATE
	OR ALTER VIEW AGO_ATTRIBUTE_VALUES AS
SELECT
	LOGICALREF id,
	CHARCODEREF attributeKeyId,
	CODE code,
	NAME name
FROM
	GIYIMDB..LG_002_CHARVAL
GO
	-- alternatives model
	CREATE
	OR ALTER VIEW AGO_ATTRIBUTES AS
SELECT
	LOGICALREF id,
	ITEMREF itemId,
	CHARCODEREF attributeKeyId,
	CHARVALREF attributeValueId
FROM
	GIYIMDB..LG_002_CHARASGN
GO
	-- 	-- alternatives
	-- 	CREATE
	-- 	OR ALTER VIEW AGO_alternativeS AS
	-- SELECT
	-- 	ITM.LOGICALREF itemId,
	-- 	VARI.LOGICALREF alternativeItemId
	-- FROM
	-- 	GIYIMDB..LG_002_ITEMS ITM
	-- 	INNER JOIN LG_002_ITEMS VARI ON VARI.NAME3 = ITM.NAME3
	-- 	AND ITM.NAME3 <> ''
	-- 	AND ITM.LOGICALREF <> VARI.LOGICALREF
GO
	-- serviceCards model
	CREATE
	OR ALTER VIEW AGO_SERVICE_CARDS AS
SELECT
	LOGICALREF id,
	CODE code,
	DEFINITION_ name,
	UNITSETREF unitId,
	CYPHCODE cyphcode,
	SPECODE specode,
	SPECODE2 specode2,
	SPECODE3 specode3,
	SPECODE4 specode4,
	SPECODE5 specode5,
	CARDTYPE type,
	CAPIBLOCK_CREADEDDATE createdAt,
	CAPIBLOCK_MODIFIEDDATE updatedAt
FROM
	GIYIMDB..LG_002_SRVCARD
WHERE
	SPECODE NOT IN ('ANA GRUP', 'ALT GRUP')
	AND CODE <> 'ÿ'
GO
	-- discountCards model
	CREATE
	OR ALTER VIEW AGO_DISCOUNT_CARDS AS
SELECT
	LOGICALREF id,
	CODE code,
	DEFINITION_ name,
	CYPHCODE cyphcode,
	SPECODE specode,
	CARDTYPE type,
	CAPIBLOCK_CREADEDDATE createdAt,
	CAPIBLOCK_MODIFIEDDATE updatedAt
FROM
	GIYIMDB..LG_002_DECARDS
WHERE
	SPECODE NOT IN ('ANA GRUP', 'ALT GRUP')
	AND CODE <> 'ÿ'
GO
	-- items model
	CREATE
	OR ALTER VIEW AGO_ITEMS AS
SELECT
	ITM.LOGICALREF id,
	ITM.CODE code,
	ITM.B2CCODE eCode,
	CASE
		WHEN ITM.ACTIVE = 0 THEN 1
		ELSE 0
	END active,
	CASE
		WHEN ITM.EXTACCESSFLAGS IN(4, 5, 6, 7) THEN 1
		ELSE 0
	END eActive,
	ITM.CARDTYPE cardType,
	ITM.NAME name,
	ITM.NAME2 name2,
	ITM.NAME3 name3,
	ITM.NAME4 name4,
	ITM.SPECODE specode1,
	ITM.SPECODE2 specode2,
	ITM.SPECODE3 specode3,
	ITM.SPECODE4 specode4,
	ITM.SPECODE5 specode5,
	ITM.KEYWORD1 keyword1,
	ITM.KEYWORD2 keyword2,
	ITM.KEYWORD3 keyword3,
	ITM.KEYWORD4 keyword4,
	ITM.KEYWORD5 keyword5,
	ITM.ORIGIN origin,
	ITM.STGRPCODE category,
	UL.NAME mainUnit,
	UL.LOGICALREF mainUnitId,
	ITM.MARKREF brandId,
	ITM.PRODUCERCODE producerCode,
	ISNULL(MK.SUBSGOODCODE, '') variationCode,
	NULLIF(MK.REYONCODE, '') reyonCode,
	ISNULL(ITM.SALESLIMITQUANTITY, 0) salesLimitQuantity
FROM
	GIYIMDB..LG_002_ITEMS ITM
	LEFT JOIN GIYIMDB..LG_002_UNITSETL UL (NOLOCK) ON UL.UNITSETREF = ITM.UNITSETREF
	AND UL.MAINUNIT = 1
	LEFT JOIN GIYIMDB..LG_002_ITEMS MG (NOLOCK) ON MG.SPECODE = 'ANA GRUP'
	AND MG.CARDTYPE IN(1, 20, 21)
	AND MG.CODE = LEFT(ITM.CODE, LEN(MG.CODE))
	LEFT JOIN GIYIMDB..LG_002_ITEMS LG (NOLOCK) ON LG.SPECODE = 'ALT GRUP'
	AND LG.CARDTYPE IN(1, 20, 21)
	AND LG.CODE = LEFT(ITM.CODE, LEN(LG.CODE))
	LEFT JOIN GIYIMDB..LG_002_MARKET MK (NOLOCK) ON MK.ITEMREF = ITM.LOGICALREF
WHERE
	ITM.SPECODE NOT IN ('ANA GRUP', 'ALT GRUP')
	AND ITM.CARDTYPE = 1
GO
	-- brands model
	CREATE
	OR ALTER VIEW AGO_BRANDS AS
SELECT
	LOGICALREF id,
	CODE code,
	DESCR name,
	CAPIBLOCK_CREADEDDATE createdAt,
	CAPIBLOCK_MODIFIEDDATE updatedAt
FROM
	GIYIMDB..LG_002_MARK (NOLOCK)
GO
	-- clients model
	CREATE
	OR ALTER VIEW AGO_CLIENTS AS
SELECT
	CLCARD.LOGICALREF id,
	CASE
		WHEN CLCARD.ACTIVE = 0 THEN 1
		ELSE 0
	END active,
	CARDTYPE cardType,
	CODE code,
	DEFINITION_ name,
	DEFINITION2 name2,
	LOGOID eCode,
	ADDR1 address,
	ADDR2 address2,
	DISTRICT district,
	TOWN town,
	CITY city,
	CITYCODE cityCode,
	COUNTRY country,
	COUNTRYCODE countryCode,
	TELNRS1 phoneNumber,
	TELNRS2 phoneNumber2,
	EMAILADDR email,
	EMAILADDR2 email2,
	EMAILADDR3 email3,
	INCHARGE incharge,
	INCHARGE2 incharge2,
	INCHARGE3 incharge3,
	WEBADDR webAddress,
	CASE
		WHEN ISDATE(INCHARGE3) = 1 THEN INCHARGE3
		ELSE null
	END birthDate,
	ISNULL(NULLIF(CCURRENCY, 0), 158) currencyId,
	CURRATETYPE exchangeRateType,
	DISCRATE discount,
	SPECODE specode,
	SPECODE2 specode2,
	SPECODE3 specode3,
	SPECODE4 specode4,
	SPECODE5 specode5,
	CYPHCODE cyphcode,
	STORECREDITCARDNO cardNo,
	GUID guid
FROM
	GIYIMDB..LG_002_CLCARD CLCARD (NOLOCK)
WHERE
	CARDTYPE IN(1, 3)
	AND SPECODE NOT IN('ANA GRUP', 'ALT GRUP')
GO
	-- currencies model
	CREATE
	OR ALTER VIEW AGO_CURRENCIES AS
SELECT
	CURTYPE id,
	CURCODE code,
	CURNAME name,
	CURSYMBOL symbol,
	CURINUSE activelyUsed
FROM
	LOGODB..L_CURRENCYLIST (NOLOCK)
WHERE
	FIRMNR = 002
GO
	-- exchanges model
	CREATE
	OR ALTER VIEW AGO_EXCHANGES AS
SELECT
	LREF id,
	LOGODB.dbo.AGO_INTTODATE(DATE_) date,
	crtype currencyId,
	ROUND(rates1, 10) rates1,
	ROUND(rates2, 10) rates2,
	ROUND(rates3, 10) rates3,
	ROUND(rates4, 10) rates4
FROM
	LOGODB..L_DAILYEXCHANGES (NOLOCK)
GO
	-- divisions model
	CREATE
	OR ALTER VIEW AGO_DIVISIONS AS
SELECT
	LOGICALREF id,
	NR nr,
	NAME name,
	STREET street,
	DOORNR doorNr,
	DISTRICT district,
	CITY city,
	COUNTRY country,
	ZIPCODE zipCode,
	PHONE phone
FROM
	LOGODB..L_CAPIDIV (NOLOCK)
WHERE
	FIRMNR = 002
GO
	-- itemUnits model
	CREATE
	OR ALTER VIEW AGO_ITEM_UNITS AS
SELECT
	ITMUNITA.LOGICALREF id,
	UNITSETL.LOGICALREF unitId,
	ITMUNITA.ITEMREF itemId,
	UNITSETL.MAINUNIT mainUnit,
	ITMUNITA.LINENR lineNr,
	ITMUNITA.CONVFACT2 / CASE
		WHEN ISNULL(ITMUNITA.CONVFACT1, 0) = 0 THEN 1
		ELSE ITMUNITA.CONVFACT1
	END coefficient,
	CASE
		WHEN ITMUNITA.EXTACCESSFLAGS IN(1, 3) THEN 1
		ELSE 0
	END eActive,
	ITMUNITA.WIDTH width,
	NULLIF(WIDTH.CODE, '') widthUnit,
	ITMUNITA.LENGTH length,
	NULLIF(LENGTH.CODE, '') lengthUnit,
	ITMUNITA.HEIGHT height,
	NULLIF(HEIGHT.CODE, '') heightUnit,
	ITMUNITA.AREA area,
	NULLIF(AREA.CODE, '') areaUnit,
	ITMUNITA.VOLUME_ volume,
	NULLIF(VOLUME.CODE, '') volumeUnit,
	ITMUNITA.WEIGHT weight,
	NULLIF(WEIGHT.CODE, '') weightUnit,
	ITMUNITA.GROSSVOLUME grossvolume,
	NULLIF(GROSSVOLUME.CODE, '') grossvolumeUnit,
	ITMUNITA.GROSSWEIGHT grossweight,
	NULLIF(GROSSWEIGHT.CODE, '') grossweightUnit
FROM
	GIYIMDB..LG_002_ITMUNITA ITMUNITA (NOLOCK)
	JOIN GIYIMDB..LG_002_UNITSETL UNITSETL (NOLOCK) ON UNITSETL.LOGICALREF = ITMUNITA.UNITLINEREF
	LEFT JOIN GIYIMDB..LG_002_UNITSETL WIDTH (NOLOCK) ON WIDTH.LOGICALREF = ITMUNITA.WIDTHREF
	LEFT JOIN GIYIMDB..LG_002_UNITSETL [LENGTH] (NOLOCK) ON [LENGTH].LOGICALREF = ITMUNITA.LENGTHREF
	LEFT JOIN GIYIMDB..LG_002_UNITSETL HEIGHT (NOLOCK) ON HEIGHT.LOGICALREF = ITMUNITA.HEIGHTREF
	LEFT JOIN GIYIMDB..LG_002_UNITSETL AREA (NOLOCK) ON AREA.LOGICALREF = ITMUNITA.AREAREF
	LEFT JOIN GIYIMDB..LG_002_UNITSETL VOLUME (NOLOCK) ON VOLUME.LOGICALREF = ITMUNITA.VOLUMEREF
	LEFT JOIN GIYIMDB..LG_002_UNITSETL [WEIGHT] (NOLOCK) ON [WEIGHT].LOGICALREF = ITMUNITA.WEIGHTREF
	LEFT JOIN GIYIMDB..LG_002_UNITSETL GROSSVOLUME (NOLOCK) ON GROSSVOLUME.LOGICALREF = ITMUNITA.GROSSVOLREF
	LEFT JOIN GIYIMDB..LG_002_UNITSETL GROSSWEIGHT (NOLOCK) ON GROSSWEIGHT.LOGICALREF = ITMUNITA.GROSSWGHTREF
GO
	-- unitSets model
	CREATE
	OR ALTER VIEW AGO_UNIT_SETS AS
SELECT
	LOGICALREF id,
	code,
	name,
	specode,
	CAPIBLOCK_CREADEDDATE createdAt,
	CAPIBLOCK_MODIFIEDDATE updatedAt
FROM
	GIYIMDB..LG_002_UNITSETF
GO
	-- units model
	CREATE
	OR ALTER VIEW AGO_UNITS AS
SELECT
	LOGICALREF id,
	CODE code,
	NAME name,
	UNITSETREF unitSetId
FROM
	GIYIMDB..LG_002_UNITSETL (NOLOCK)
GO
	--warehouses model
	CREATE
	OR ALTER VIEW AGO_WAREHOUSES AS
SELECT
	LOGICALREF id,
	NR nr,
	NAME name,
	DIVISNR divisionNr,
	FACTNR factoryNr,
	COSTGRP costGrp
FROM
	LOGODB..L_CAPIWHOUSE (NOLOCK)
WHERE
	FIRMNR = 002
	AND NR <> 0
GO
	-- stocks model
	CREATE
	OR ALTER VIEW AGO_STOCKS AS
SELECT
	STOCKREF itemId,
	INVENNO warehouseNr,
	ROUND(ONHAND, 4) onhand,
	ROUND(RESERVED, 4) reserved
FROM
	GIYIMDB.dbo.LV_002_01_GNTOTST (NOLOCK)
WHERE
	INVENNO NOT IN(-1, 0)
GO
	-- barcodes model
	CREATE
	OR ALTER VIEW AGO_BARCODES AS
SELECT
	BARCODE.LOGICALREF id,
	BARCODE.ITEMREF itemId,
	BARCODE.ITMUNITAREF itemUnitId,
	BARCODE.UNITLINEREF unitId,
	BARCODE.LINENR lineNr,
	BARCODE.BARCODE barcode,
	CAPIBLOCK_CREADEDDATE createdAt,
	CAPIBLOCK_MODIFIEDDATE updatedAt
FROM
	GIYIMDB..LG_002_UNITBARCODE BARCODE (NOLOCK)
GO
	-- price model
	CREATE
	OR ALTER VIEW AGO_PRICES AS
SELECT
	PRICE.LOGICALREF id,
	PRICE.CODE code,
	PRICE.CARDREF itemId,
	PRIORITY priority,
	CLIENTCODE clentcode,
	CLCYPHCODE clcyphcode,
	CLSPECODE clspecode,
	CLSPECODE2 clspecode2,
	CLSPECODE3 clspecode3,
	CLSPECODE4 clspecode4,
	CLSPECODE5 clspecode5,
	CASE
		WHEN PRICEDIV.DIVCODES = '-1' THEN '[]'
		ELSE LOGODB.dbo.AGO_SPLIT(PRICEDIV.DIVCODES, ';')
	END divisions,
	-- IF [] ALL DIVISIONS
	CASE
		WHEN PRICE.ACTIVE = 0 THEN 1
		ELSE 0
	END active,
	PRICE.PRICE price,
	PRICE.CURRENCY currencyId,
	PRICE.PTYPE type,
	PRICE.UOMREF unitId,
	CONCAT(
		FORMAT(PRICE.BEGDATE, 'yyyy-MM-dd '),
		LOGODB.DBO.AGO_INTTOTIME(BEGTIME)
	) beginTime,
	CONCAT(
		FORMAT(PRICE.ENDDATE, 'yyyy-MM-dd '),
		LOGODB.DBO.AGO_INTTOTIME(ENDTIME)
	) endTime
FROM
	GIYIMDB..LG_002_PRCLIST PRICE (NOLOCK)
	LEFT JOIN GIYIMDB..LG_002_PRCLSTDIV PRICEDIV (NOLOCK) ON PRICEDIV.PARENTPRCREF = PRICE.LOGICALREF
GO
	CREATE
	OR ALTER VIEW AGO_ALTERNATIVES AS
SELECT
	LOGICALREF id,
	MAINITEMREF itemId,
	SUBITEMREF alternativeItemId,
	LINENO_ lineNumber,
	PRIORITY priority,
	MAXQUANTITY maxQuantity,
	MINQUANTITY minQuantity,
	BEGDATE beginDate,
	ENDDATE endDate,
	CASE
		WHEN SOURCEINDEX = -1 THEN NULL
		ELSE SOURCEINDEX
	END divisionNr
FROM
	GIYIMDB.dbo.LG_002_ITEMSUBS
GO
	CREATE
	OR ALTER VIEW AGO_BANKS AS
SELECT
	LOGICALREF id,
	CASE
		WHEN ACTIVE = 0 THEN 1
		ELSE 0
	END active,
	CODE code,
	DEFINITION_ NAME,
	ADDR1 address,
	ADDR2 address2,
	CITY city,
	COUNTRY country,
	POSTCODE postcode,
	TELNRS1 telNumber,
	TELNRS2 telNumber2,
	EMAILADDR email,
	WEBADDR webAddress,
	CAPIBLOCK_CREADEDDATE createdAt,
	CAPIBLOCK_MODIFIEDDATE updatedAt
FROM
	LG_002_BNCARD
WHERE
	SPECODE NOT IN('ANA GRUP', 'ALT GRUP')
GO
	CREATE
	OR ALTER VIEW AGO_BANK_ACCOUNTS AS
SELECT
	LOGICALREF id,
	CASE
		WHEN ACTIVE = 0 THEN 1
		ELSE 0
	END active,
	BANKREF bankId,
	CASE
		WHEN CURRENCY = 0 THEN 158
		ELSE CURRENCY
	END currencyId,
	accountNo,
	CODE code,
	DEFINITION_ NAME,
	specode,
	CAPIBLOCK_CREADEDDATE createdAt,
	CAPIBLOCK_MODIFIEDDATE updatedAt
FROM
	LG_002_BANKACC
WHERE
	SPECODE NOT IN('ANA GRUP', 'ALT GRUP')
GO
	CREATE
	OR ALTER VIEW AGO_CASES AS
SELECT
	LOGICALREF id,
	CASE
		WHEN ACTIVE = 0 THEN 1
		ELSE 0
	END active,
	CODE code,
	NAME name,
	ADDR1 address,
	ADDR2 address2,
	CASE
		WHEN CCURRENCY = 0 THEN 158
		ELSE CCURRENCY
	END currencyId,
	NULLIF(BRANCH, -1) divisionNr,
	CAPIBLOCK_CREADEDDATE createdAt,
	CAPIBLOCK_MODIFIEDDATE updatedAt
FROM
	LG_002_KSCARD
WHERE
	SPECODE NOT IN ('ANA GRUP', 'ALT GRUP')
GO
	CREATE
	OR ALTER VIEW AGO_EMPLOYEES AS
SELECT
	LOGICALREF id,
	CODE code,
	DEFINITION_ name,
	TELNUMBER phoneNumber,
	SPECODE specode,
	CASE
		WHEN ACTIVE = 0 THEN 1
		ELSE 0
	END active,
	CAPIBLOCK_CREADEDDATE createdAt,
	CAPIBLOCK_MODIFIEDDATE updatedAt
FROM
	LOGODB..LG_SLSMAN
WHERE
	FIRMNR = 002